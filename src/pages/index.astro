---
import AppLayout from '../layouts/AppLayout.astro';
import { getDictionary } from '../lib/i18n';
import AuthRequired from '../components/AuthRequired.astro';
const locale: 'en' | 'de' = 'en';
const t = getDictionary(locale);
const user = (Astro.locals as any)?.user ?? null;

const mealRows = [
  { key: 'BREAKFAST', label: 'Breakfast', target: 500 },
  { key: 'LUNCH', label: 'Lunch', target: 700 },
  { key: 'DINNER', label: 'Dinner', target: 600 },
  { key: 'SNACKS', label: 'Snacks', target: 200 }
];
---

<AppLayout title={t.appName} currentTab="today" locale={locale}>
  {
    !user ? (
      <>
        <section class="mb-4 rounded-2xl app-card p-6 rise">
          <p class="text-xs uppercase tracking-[0.2em] text-brand-700">Nutrition with context</p>
          <h1 class="mt-2 text-3xl font-semibold text-slate-900">Track calories, water, and activity in one flow.</h1>
          <p class="mt-2 max-w-prose text-sm text-slate-600">
            Your timeline, local product library, and weekly goals are synced to your account and available offline.
          </p>
          <div class="mt-4 flex gap-2">
            <a href="/register" data-astro-prefetch class="rounded-xl bg-brand-600 px-4 py-2 text-sm font-semibold text-white">Get started</a>
            <a href="/login" data-astro-prefetch class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700">I already have an account</a>
          </div>
        </section>
        <AuthRequired />
      </>
    ) : (
      <>
  <section class="mb-4 rounded-2xl app-card p-4 rise">
    <h2 class="mb-3 text-lg font-semibold">{t.summary}</h2>
    <dl class="grid grid-cols-2 gap-3 sm:grid-cols-3">
      <div class="rounded-xl bg-brand-50 p-3">
        <dt class="text-xs text-slate-600">Eaten</dt>
        <dd id="sum-eaten" class="text-xl font-semibold">0 kcal</dd>
      </div>
      <div class="rounded-xl bg-brand-50 p-3">
        <dt class="text-xs text-slate-600">Remaining</dt>
        <dd id="sum-remaining" class="text-xl font-semibold">2000 kcal</dd>
      </div>
      <div class="rounded-xl bg-brand-50 p-3">
        <dt class="text-xs text-slate-600">Burned</dt>
        <dd id="sum-burned" class="text-xl font-semibold">0 kcal</dd>
      </div>
      <div class="rounded-xl bg-white p-3">
        <dt class="text-xs text-slate-600">Carbs</dt>
        <dd id="sum-carbs" class="text-xl font-semibold">0 g</dd>
      </div>
      <div class="rounded-xl bg-white p-3">
        <dt class="text-xs text-slate-600">Protein</dt>
        <dd id="sum-protein" class="text-xl font-semibold">0 g</dd>
      </div>
      <div class="rounded-xl bg-white p-3">
        <dt class="text-xs text-slate-600">Fat</dt>
        <dd id="sum-fat" class="text-xl font-semibold">0 g</dd>
      </div>
    </dl>
  </section>

  <section class="mb-4 rounded-2xl app-card p-4 rise rise-delay-1">
    <h2 class="mb-3 text-lg font-semibold">{t.nutrition}</h2>
    <ul class="space-y-2">
      {mealRows.map((row) => (
        <li class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-3 py-2">
          <div class="flex items-center gap-3">
            <span class="rounded-full bg-brand-100 px-2 py-1 text-xs font-medium text-brand-800">{row.label[0]}</span>
            <div>
              <p class="text-sm font-medium">{row.label}</p>
              <p class="text-xs text-slate-500">
                <span data-meal-kcal={row.key}>0</span> / {row.target} kcal
              </p>
            </div>
          </div>
          <a href="/add?tab=meal" data-astro-prefetch class="rounded-full bg-slate-100 px-3 py-1 text-sm font-medium hover:bg-slate-200">
            +
          </a>
        </li>
      ))}
    </ul>
  </section>

  <section class="mb-4 grid gap-4 sm:grid-cols-2 rise rise-delay-2">
    <div class="rounded-2xl app-card p-4">
      <p class="text-xs uppercase tracking-wide text-slate-500">{t.water}</p>
      <p class="mt-2 text-sm text-slate-600">Goal: 2.00 L</p>
      <p id="water-total" class="mt-3 text-3xl font-semibold">0.00 L</p>
      <div class="mt-3 flex gap-2">
        <button type="button" data-water="250" class="rounded-lg bg-brand-600 px-3 py-2 text-xs font-semibold text-white">
          +250 ml
        </button>
        <button type="button" data-water="500" class="rounded-lg bg-brand-600 px-3 py-2 text-xs font-semibold text-white">
          +500 ml
        </button>
      </div>
    </div>

    <div class="rounded-2xl app-card p-4">
      <p class="text-xs uppercase tracking-wide text-slate-500">{t.activities}</p>
      <p class="mt-2 text-sm text-slate-600">Dual entry: direct calories or estimated activity.</p>
      <a
        href="/add?tab=meal"
        data-astro-prefetch
        class="mt-3 inline-flex rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-100"
      >
        Add activity
      </a>
    </div>
  </section>

      <script>
    // @ts-nocheck
    async function addWater(amountMl) {
      await fetch('/api/logs/water', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ amountMl })
      });
      await loadSummary();
    }

    document.querySelectorAll('[data-water]').forEach((button) => {
      button.addEventListener('click', () => addWater(Number(button.getAttribute('data-water'))));
    });

    async function loadSummary() {
      const [mealRes, goalRes, activityRes, waterRes] = await Promise.all([
        fetch('/api/logs/meals'),
        fetch('/api/goals'),
        fetch('/api/logs/activities'),
        fetch('/api/logs/water')
      ]);
      if (!mealRes.ok) {
        return;
      }

      const mealData = await mealRes.json();
      const goalData = goalRes.ok ? await goalRes.json() : { goal: null };
      const targetCalories = goalData.goal?.dailyCalorieTarget ?? 2000;

      let eaten = 0;
      let protein = 0;
      let carbs = 0;
      let fat = 0;
      let burned = 0;
      const mealTotals = {
        BREAKFAST: 0,
        LUNCH: 0,
        DINNER: 0,
        SNACKS: 0
      } as Record<string, number>;

      (mealData.entries ?? []).forEach((entry) => {
        eaten += Number(entry.calories ?? 0);
        protein += Number(entry.protein ?? 0);
        carbs += Number(entry.carbs ?? 0);
        fat += Number(entry.fat ?? 0);
        mealTotals[String(entry.mealType)] = (mealTotals[String(entry.mealType)] ?? 0) + Number(entry.calories ?? 0);
      });

      if (activityRes.ok) {
        const activityData = await activityRes.json();
        burned = Number(activityData.burned ?? 0);
      }

      document.querySelector('#sum-eaten')!.textContent = `${Math.round(eaten)} kcal`;
      document.querySelector('#sum-remaining')!.textContent = `${Math.round(Math.max(0, targetCalories - eaten + burned))} kcal`;
      document.querySelector('#sum-burned')!.textContent = `${Math.round(burned)} kcal`;
      document.querySelector('#sum-carbs')!.textContent = `${carbs.toFixed(1)} g`;
      document.querySelector('#sum-protein')!.textContent = `${protein.toFixed(1)} g`;
      document.querySelector('#sum-fat')!.textContent = `${fat.toFixed(1)} g`;

      Object.entries(mealTotals).forEach(([key, value]) => {
        const node = document.querySelector(`[data-meal-kcal="${key}"]`);
        if (node) {
          node.textContent = String(Math.round(value));
        }
      });

      if (waterRes.ok) {
        const waterData = await waterRes.json();
        const currentWater = Number(waterData.totalMl ?? 0) / 1000;
        document.querySelector('#water-total')!.textContent = `${currentWater.toFixed(2)} L`;
      }
    }

    loadSummary();
      </script>
      </>
    )
  }
</AppLayout>
