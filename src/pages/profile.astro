---
import AppLayout from '../layouts/AppLayout.astro';
import AuthRequired from '../components/AuthRequired.astro';

const locale: 'en' | 'de' = 'en';
const user = (Astro.locals as any)?.user ?? null;
---

<AppLayout title="Profile" currentTab="profile" locale={locale}>
  {
    !user ? (
      <AuthRequired />
    ) : (
      <>
  <section class="mb-4 rounded-2xl app-card p-4 rise">
    <h1 class="text-xl font-semibold">Profile</h1>
    <p id="profile-meta" class="mt-1 text-sm text-slate-600">Loading profile...</p>

    <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-4">
      <div class="rounded-xl bg-brand-50 p-3">
        <p class="text-xs text-slate-500">Streak</p>
        <p class="text-lg font-semibold">7 days</p>
      </div>
      <div class="rounded-xl bg-brand-50 p-3">
        <p class="text-xs text-slate-500">Goals</p>
        <p id="goal-meta" class="text-lg font-semibold">-</p>
      </div>
      <div class="rounded-xl bg-brand-50 p-3">
        <p class="text-xs text-slate-500">Badges</p>
        <p class="text-lg font-semibold">3</p>
      </div>
      <div class="rounded-xl bg-brand-50 p-3">
        <p class="text-xs text-slate-500">Reminders</p>
        <p class="text-lg font-semibold">On</p>
      </div>
    </div>
  </section>

  <section class="mb-4 rounded-2xl app-card p-4 rise rise-delay-1">
    <h2 class="mb-3 text-lg font-semibold">Your products</h2>
    <ul id="product-list" class="space-y-2 text-sm text-slate-700"></ul>
    <div id="product-toast" class="pointer-events-none fixed bottom-22 left-1/2 z-50 hidden w-[min(90vw,30rem)] -translate-x-1/2 rounded-xl border border-slate-200 bg-white p-3 shadow-xl">
      <p id="product-toast-text" class="text-sm text-slate-800"></p>
      <div class="mt-2 flex items-center justify-end gap-2">
        <button id="product-toast-undo" type="button" class="pointer-events-auto rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700">Undo</button>
      </div>
    </div>
  </section>

  <section class="rounded-2xl app-card p-4 rise rise-delay-2">
    <a href="/share" class="mb-3 inline-flex rounded-xl bg-brand-600 px-3 py-2 text-sm font-semibold text-white">Create share card</a>
    <h2 class="mb-3 text-lg font-semibold">Admin moderation (inline)</h2>
    <ul id="submission-list" class="space-y-2 text-sm text-slate-700"></ul>
  </section>
      </>
    )
  }

  <script>
    // @ts-nocheck
    const profileMeta = document.querySelector('#profile-meta') as HTMLParagraphElement;
    const goalMeta = document.querySelector('#goal-meta') as HTMLParagraphElement;
    const productList = document.querySelector('#product-list') as HTMLUListElement;
    const productToast = document.querySelector('#product-toast') as HTMLDivElement | null;
    const productToastText = document.querySelector('#product-toast-text') as HTMLParagraphElement | null;
    const productToastUndo = document.querySelector('#product-toast-undo') as HTMLButtonElement | null;
    const submissionList = document.querySelector('#submission-list') as HTMLUListElement;
    let products: Array<{
      id: string;
      name: string;
      brand?: string;
      isAiEstimated: boolean;
      isGlobal: boolean;
      publicationStatus: string;
    }> = [];
    let pendingDelete: {
      item: {
        id: string;
        name: string;
        brand?: string;
        isAiEstimated: boolean;
        isGlobal: boolean;
        publicationStatus: string;
      };
      index: number;
      timeoutId: number;
    } | null = null;

    function showProductToast(message: string) {
      if (!productToast || !productToastText) {
        return;
      }

      productToastText.textContent = message;
      productToast.classList.remove('hidden');
    }

    function hideProductToast() {
      productToast?.classList.add('hidden');
    }

    function renderProducts() {
      if (!products.length) {
        productList.innerHTML = '<li class="rounded-xl border border-slate-200 bg-white p-3 text-slate-500">No products yet. Add one from the Product tab.</li>';
        return;
      }

      productList.innerHTML = products
        .map(
          (item) => {
            const removeAction = item.isGlobal
              ? '<span class="text-xs text-slate-500">Published globally</span>'
              : `<button type="button" data-product-remove-id="${item.id}" class="rounded-lg border border-rose-200 bg-rose-50 px-2 py-1 text-xs font-semibold text-rose-700">Remove product</button>`;
            return `<li class="rounded-xl border border-slate-200 bg-white p-3"><div class="flex items-start justify-between gap-3"><div>${item.name} ${item.brand ? `- ${item.brand}` : ''} ${item.isAiEstimated ? '<span class="ml-2 text-xs text-rose-600">AI</span>' : ''}</div>${removeAction}</div></li>`;
          }
        )
        .join('');
    }

    async function commitPendingDelete() {
      if (!pendingDelete) {
        return;
      }

      const activeDelete = pendingDelete;
      pendingDelete = null;
      hideProductToast();

      const response = await fetch('/api/products', {
        method: 'DELETE',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ productId: activeDelete.item.id })
      });

      if (response.ok) {
        return;
      }

      const restoreIndex = Math.max(0, Math.min(activeDelete.index, products.length));
      products.splice(restoreIndex, 0, activeDelete.item);
      renderProducts();
      showProductToast('Could not remove product. Please try again.');
      window.setTimeout(() => {
        hideProductToast();
      }, 2200);
    }

    function queueDelete(productId: string) {
      const index = products.findIndex((item) => item.id === productId);
      if (index === -1) {
        return;
      }

      if (pendingDelete) {
        window.clearTimeout(pendingDelete.timeoutId);
        void commitPendingDelete();
      }

      const item = products[index];
      products.splice(index, 1);
      renderProducts();

      showProductToast('Product removed. Undo?');
      const timeoutId = window.setTimeout(() => {
        void commitPendingDelete();
      }, 5000);

      pendingDelete = {
        item,
        index,
        timeoutId
      };
    }

    async function loadProfile() {
      const [meRes, goalsRes, productsRes] = await Promise.all([
        fetch('/api/auth/me'),
        fetch('/api/goals'),
        fetch('/api/products')
      ]);

      if (!meRes.ok) {
        profileMeta.textContent = 'Sign in to view profile.';
        return;
      }

      const me = await meRes.json();
      const goals = await goalsRes.json();
      const productsData = await productsRes.json();

      profileMeta.textContent = `${me.user.username} (${me.user.email})`;
      goalMeta.textContent = goals.goal?.type ?? 'MAINTAIN_WEIGHT';
      products = Array.isArray(productsData.products) ? productsData.products : [];
      renderProducts();

      if (me.user.isAdmin) {
        const submissionsRes = await fetch('/api/admin/moderation/submissions');
        if (submissionsRes.ok) {
          const data = await submissionsRes.json();
          submissionList.innerHTML = (data.submissions ?? [])
            .map(
              (submission: { id: string; product: { name: string }; submittedBy: { username: string } }) =>
                `<li class="rounded-xl border border-slate-200 bg-white p-3"><p class="font-semibold">${submission.product.name}</p><p class="text-xs text-slate-500">By ${submission.submittedBy.username}</p><div class="mt-2 flex gap-2"><button data-review-id="${submission.id}" data-status="APPROVED" class="rounded-lg bg-emerald-600 px-3 py-1 text-xs font-semibold text-white">Approve</button><button data-review-id="${submission.id}" data-status="REJECTED" class="rounded-lg bg-rose-600 px-3 py-1 text-xs font-semibold text-white">Reject</button></div></li>`
            )
            .join('');

          submissionList.querySelectorAll('button[data-review-id]').forEach((button) => {
            button.addEventListener('click', async () => {
              await fetch('/api/admin/moderation/submissions', {
                method: 'PATCH',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({
                  submissionId: button.getAttribute('data-review-id'),
                  status: button.getAttribute('data-status')
                })
              });
              loadProfile();
            });
          });
        }
      } else {
        submissionList.innerHTML = '<li class="rounded-xl border border-slate-200 bg-white p-3">Admin only.</li>';
      }
    }

    productList.addEventListener('click', (event) => {
      const target = event.target as HTMLElement | null;
      const removeButton = target?.closest('[data-product-remove-id]') as HTMLButtonElement | null;
      if (!removeButton) {
        return;
      }

      const productId = removeButton.getAttribute('data-product-remove-id');
      if (!productId) {
        return;
      }

      queueDelete(productId);
    });

    productToastUndo?.addEventListener('click', () => {
      if (!pendingDelete) {
        hideProductToast();
        return;
      }

      window.clearTimeout(pendingDelete.timeoutId);
      const restoreIndex = Math.max(0, Math.min(pendingDelete.index, products.length));
      products.splice(restoreIndex, 0, pendingDelete.item);
      pendingDelete = null;
      hideProductToast();
      renderProducts();
    });

    loadProfile();
  </script>
</AppLayout>
