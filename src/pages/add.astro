---
import AppLayout from '../layouts/AppLayout.astro';
import AuthRequired from '../components/AuthRequired.astro';

const locale: 'en' | 'de' = 'en';
const selectedTab = Astro.url.searchParams.get('tab') === 'product' ? 'product' : 'meal';
const user = (Astro.locals as any)?.user ?? null;
---

<AppLayout title="Add" currentTab="add" locale={locale}>
  {
    !user ? (
      <AuthRequired />
    ) : (
      <section id="add-tabs-root" data-initial-tab={selectedTab} class="mb-4 rounded-2xl app-card p-4 rise">
        <h1 class="mb-3 text-xl font-semibold">Quick Add</h1>
        <div role="tablist" aria-label="Add mode" class="mb-4 grid grid-cols-2 gap-2">
          <button
            id="meal-tab-trigger"
            type="button"
            role="tab"
            aria-controls="meal-panel"
            data-tab="meal"
            class="rounded-xl px-4 py-2 text-center text-sm font-medium"
          >
            Meal
          </button>
          <button
            id="product-tab-trigger"
            type="button"
            role="tab"
            aria-controls="product-panel"
            data-tab="product"
            class="rounded-xl px-4 py-2 text-center text-sm font-medium"
          >
            Product
          </button>
        </div>

        <div id="meal-panel" role="tabpanel" aria-labelledby="meal-tab-trigger">
          <div role="tablist" aria-label="Meal add mode" class="mb-4 grid grid-cols-2 gap-2">
            <button
              id="meal-existing-tab-trigger"
              type="button"
              role="tab"
              aria-controls="meal-existing-panel"
              class="rounded-xl px-4 py-2 text-center text-sm font-medium"
            >
              Existing Meal
            </button>
            <button
              id="meal-manual-tab-trigger"
              type="button"
              role="tab"
              aria-controls="meal-manual-panel"
              class="rounded-xl px-4 py-2 text-center text-sm font-medium"
            >
              Manual
            </button>
          </div>

          <div id="meal-existing-panel" role="tabpanel" aria-labelledby="meal-existing-tab-trigger">
            <form id="meal-existing-form" class="space-y-3">
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Meal Type</span>
                <select name="mealType" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                  <option value="BREAKFAST">Breakfast</option>
                  <option value="LUNCH">Lunch</option>
                  <option value="DINNER">Dinner</option>
                  <option value="SNACKS">Snacks</option>
                </select>
              </label>

              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Find product</span>
                <input
                  id="product-search"
                  type="text"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
                  placeholder="Type to filter products"
                />
              </label>

              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Product</span>
                <select
                  id="meal-product-select"
                  required
                  name="productId"
                  size="6"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
                ></select>
              </label>

              <div class="grid grid-cols-2 gap-3">
                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Quantity</span>
                  <input
                    required
                    min="0.1"
                    step="0.1"
                    type="number"
                    name="quantityValue"
                    class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
                  />
                </label>

                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Unit</span>
                  <select id="meal-quantity-unit" name="quantityUnit" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                    <option value="g">g</option>
                    <option value="ml">ml</option>
                    <option value="serving">serving</option>
                    <option value="piece">piece</option>
                  </select>
                </label>
              </div>

              <p id="meal-existing-error" class="text-sm text-rose-600"></p>

              <button class="w-full rounded-xl bg-brand-600 px-4 py-2 font-semibold text-white hover:bg-brand-700" type="submit">
                Save meal entry
              </button>
            </form>
          </div>

          <div id="meal-manual-panel" role="tabpanel" aria-labelledby="meal-manual-tab-trigger" class="hidden">
            <form id="meal-manual-form" class="space-y-3">
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Meal Type</span>
                <select name="mealType" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                  <option value="BREAKFAST">Breakfast</option>
                  <option value="LUNCH">Lunch</option>
                  <option value="DINNER">Dinner</option>
                  <option value="SNACKS">Snacks</option>
                </select>
              </label>

              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Name (optional)</span>
                <input
                  type="text"
                  name="itemName"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
                  placeholder="e.g. Homemade curry"
                />
              </label>

              <div class="grid grid-cols-2 gap-3">
                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Quantity</span>
                  <input
                    required
                    min="0.1"
                    step="0.1"
                    type="number"
                    name="quantityValue"
                    class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
                  />
                </label>

                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Unit</span>
                  <select id="manual-quantity-unit" name="quantityUnit" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                    <option value="g">g</option>
                    <option value="ml">ml</option>
                    <option value="serving">serving</option>
                    <option value="piece">piece</option>
                  </select>
                </label>
              </div>

              <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">kcal</span>
                  <input required min="0" type="number" step="0.1" name="calories" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
                </label>
                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Protein</span>
                  <input required min="0" type="number" step="0.1" name="protein" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
                </label>
                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Carbs</span>
                  <input required min="0" type="number" step="0.1" name="carbs" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
                </label>
                <label class="block text-sm">
                  <span class="mb-1 block text-slate-700">Fat</span>
                  <input required min="0" type="number" step="0.1" name="fat" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
                </label>
              </div>

              <p id="meal-manual-error" class="text-sm text-rose-600"></p>

              <button class="w-full rounded-xl bg-brand-600 px-4 py-2 font-semibold text-white hover:bg-brand-700" type="submit">
                Save meal entry
              </button>
            </form>
          </div>
        </div>

        <div id="product-panel" role="tabpanel" aria-labelledby="product-tab-trigger">
          <form id="product-form" class="space-y-3">
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Name</span>
              <input required name="name" type="text" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Brand</span>
              <input name="brand" type="text" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>

            <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">kcal</span>
                <input min="0" type="number" step="0.1" name="calories" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
              </label>
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Protein</span>
                <input min="0" type="number" step="0.1" name="protein" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
              </label>
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Carbs</span>
                <input min="0" type="number" step="0.1" name="carbs" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
              </label>
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Fat</span>
                <input min="0" type="number" step="0.1" name="fat" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
              </label>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Nutrition basis quantity</span>
                <input
                  required
                  min="0.1"
                  step="0.1"
                  type="number"
                  name="referenceValue"
                  value="100"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
                />
              </label>
              <label class="block text-sm">
                <span class="mb-1 block text-slate-700">Nutrition basis unit</span>
                <select id="product-reference-unit" name="referenceUnit" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                  <option value="g">g</option>
                  <option value="ml">ml</option>
                  <option value="serving">serving</option>
                  <option value="piece">piece</option>
                </select>
              </label>
            </div>

            <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" name="isAiEstimated" class="rounded" />
              AI-estimated nutrition (cannot be globally published)
            </label>

            <button class="w-full rounded-xl bg-brand-600 px-4 py-2 font-semibold text-white hover:bg-brand-700" type="submit">
              Save local product
            </button>
          </form>
        </div>
      </section>
    )
  }

  <script>
    // @ts-nocheck
    function parseOptionalNumber(value) {
      if (value === null || value === undefined || String(value).trim() === '') {
        return undefined;
      }

      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : undefined;
    }

    function normalizeUnit(rawUnit) {
      const value = String(rawUnit || '').trim().toLowerCase();
      if (value === 'grams' || value === 'gram') {
        return 'g';
      }
      if (value === 'milliliters' || value === 'milliliter') {
        return 'ml';
      }
      if (value === 'servings') {
        return 'serving';
      }
      if (value === 'pieces') {
        return 'piece';
      }
      return value;
    }

    const CANONICAL_UNITS = ['g', 'ml', 'serving', 'piece'];

    function isCanonicalUnit(unit) {
      return CANONICAL_UNITS.includes(unit);
    }

    function formatAmount(value) {
      if (!Number.isFinite(value)) {
        return '0';
      }
      if (Number.isInteger(value)) {
        return String(value);
      }
      return String(Number(value.toFixed(4)));
    }

    function normalizeAliases(rawAliases) {
      return (Array.isArray(rawAliases) ? rawAliases : [])
        .filter(
          (alias) =>
            typeof alias?.fromAmount === 'number' &&
            typeof alias?.fromUnit === 'string' &&
            typeof alias?.toAmount === 'number' &&
            typeof alias?.toUnit === 'string'
        )
        .map((alias) => ({
          fromAmount: alias.fromAmount,
          fromUnit: normalizeUnit(alias.fromUnit),
          toAmount: alias.toAmount,
          toUnit: normalizeUnit(alias.toUnit)
        }));
    }

    function validateAliases(aliases) {
      const aliasUnits = new Set();

      for (const alias of aliases) {
        if (!alias.fromUnit || !alias.toUnit) {
          return { ok: false, error: 'Alias units must be non-empty.' };
        }
        if (!(alias.fromAmount > 0) || !(alias.toAmount > 0)) {
          return { ok: false, error: 'Alias amounts must be positive.' };
        }
        if (isCanonicalUnit(alias.fromUnit)) {
          return { ok: false, error: `Cannot redefine canonical unit "${alias.fromUnit}".` };
        }
        if (alias.fromUnit === alias.toUnit) {
          return { ok: false, error: `Alias "${alias.fromUnit}" cannot reference itself.` };
        }
        if (aliasUnits.has(alias.fromUnit)) {
          return { ok: false, error: `Duplicate alias unit "${alias.fromUnit}".` };
        }
        aliasUnits.add(alias.fromUnit);
      }

      for (const alias of aliases) {
        if (!isCanonicalUnit(alias.toUnit) && !aliasUnits.has(alias.toUnit)) {
          return { ok: false, error: `Alias "${alias.fromUnit}" references unknown unit "${alias.toUnit}".` };
        }
      }

      const graph = new Map();
      for (const alias of aliases) {
        if (!isCanonicalUnit(alias.toUnit)) {
          graph.set(alias.fromUnit, alias.toUnit);
        }
      }

      for (const start of graph.keys()) {
        const seen = new Set();
        let cursor = start;
        while (cursor) {
          if (seen.has(cursor)) {
            return { ok: false, error: 'Alias cycle detected.' };
          }
          seen.add(cursor);
          cursor = graph.get(cursor);
        }
      }

      return { ok: true, aliases };
    }

    function resolveToCanonical(value, unit, aliases) {
      const normalizedAliases = normalizeAliases(aliases);
      const validation = validateAliases(normalizedAliases);
      if (!validation.ok) {
        return { ok: false, error: validation.error };
      }

      const aliasMap = new Map(validation.aliases.map((alias) => [alias.fromUnit, alias]));
      let resolvedValue = value;
      let resolvedUnit = normalizeUnit(unit);
      const seen = new Set();

      while (!isCanonicalUnit(resolvedUnit)) {
        if (seen.has(resolvedUnit)) {
          return { ok: false, error: 'Alias cycle detected during conversion.' };
        }
        seen.add(resolvedUnit);
        const alias = aliasMap.get(resolvedUnit);
        if (!alias) {
          return { ok: false, error: `Unknown unit "${resolvedUnit}".` };
        }

        resolvedValue = resolvedValue * (alias.toAmount / alias.fromAmount);
        resolvedUnit = alias.toUnit;
      }

      return {
        ok: true,
        value: resolvedValue,
        unit: resolvedUnit
      };
    }

    function buildUnitOptions(aliases) {
      const aliasNames = normalizeAliases(aliases).map((alias) => alias.fromUnit);
      const uniqueAliasNames = [...new Set(aliasNames)].filter((name) => !isCanonicalUnit(name));
      return [...CANONICAL_UNITS, ...uniqueAliasNames];
    }

    function applyUnitOptions(selectElement, options) {
      if (!selectElement) {
        return;
      }

      const previous = selectElement.value;
      selectElement.innerHTML = options.map((option) => `<option value="${option}">${option}</option>`).join('');
      if (options.includes(previous)) {
        selectElement.value = previous;
      }
    }

    function parseServingSizeLabel(label) {
      const normalized = String(label || '').trim().toLowerCase();
      const match = normalized.match(/^(\d+(?:\.\d+)?)\s*([a-z][a-z0-9_-]{0,31})$/i);
      if (!match) {
        return null;
      }

      return {
        value: Number(match[1]),
        unit: normalizeUnit(match[2])
      };
    }

    function fuzzyMatch(text, query) {
      const haystack = String(text || '').toLowerCase();
      const needle = String(query || '').trim().toLowerCase();
      if (!needle) {
        return true;
      }
      if (haystack.includes(needle)) {
        return true;
      }

      let idx = 0;
      for (const ch of haystack) {
        if (ch === needle[idx]) {
          idx += 1;
          if (idx === needle.length) {
            return true;
          }
        }
      }

      return false;
    }

    function initAddPage() {
      const root = document.querySelector('#add-tabs-root');
      if (!root || root.dataset.bound === 'true') {
        return;
      }
      root.dataset.bound = 'true';

      const mealTabTrigger = document.querySelector('#meal-tab-trigger');
      const productTabTrigger = document.querySelector('#product-tab-trigger');
      const mealPanel = document.querySelector('#meal-panel');
      const mealExistingTabTrigger = document.querySelector('#meal-existing-tab-trigger');
      const mealManualTabTrigger = document.querySelector('#meal-manual-tab-trigger');
      const mealExistingPanel = document.querySelector('#meal-existing-panel');
      const mealManualPanel = document.querySelector('#meal-manual-panel');
      const productPanel = document.querySelector('#product-panel');
      const mealExistingForm = document.querySelector('#meal-existing-form');
      const mealManualForm = document.querySelector('#meal-manual-form');
      const mealExistingError = document.querySelector('#meal-existing-error');
      const mealManualError = document.querySelector('#meal-manual-error');
      const productSearch = document.querySelector('#product-search');
      const mealProductSelect = document.querySelector('#meal-product-select');
      const mealQuantityUnitSelect = document.querySelector('#meal-quantity-unit');
      const manualQuantityUnitSelect = document.querySelector('#manual-quantity-unit');
      const productReferenceUnitSelect = document.querySelector('#product-reference-unit');
      const productForm = document.querySelector('#product-form');

      let products = [];
      let productsLoaded = false;
      let unitAliases = [];
      let mealMode = 'existing';

      function setTabStyles(activeTab) {
        const mealActive = activeTab === 'meal';
        const productActive = activeTab === 'product';

        mealPanel?.classList.toggle('hidden', !mealActive);
        productPanel?.classList.toggle('hidden', !productActive);

        mealTabTrigger?.setAttribute('aria-selected', mealActive ? 'true' : 'false');
        productTabTrigger?.setAttribute('aria-selected', productActive ? 'true' : 'false');

        mealTabTrigger?.classList.toggle('bg-brand-600', mealActive);
        mealTabTrigger?.classList.toggle('text-white', mealActive);
        mealTabTrigger?.classList.toggle('bg-slate-100', !mealActive);
        mealTabTrigger?.classList.toggle('text-slate-700', !mealActive);

        productTabTrigger?.classList.toggle('bg-brand-600', productActive);
        productTabTrigger?.classList.toggle('text-white', productActive);
        productTabTrigger?.classList.toggle('bg-slate-100', !productActive);
        productTabTrigger?.classList.toggle('text-slate-700', !productActive);
      }

      function setMealModeStyles(activeMode) {
        const existingActive = activeMode === 'existing';
        const manualActive = activeMode === 'manual';

        mealExistingPanel?.classList.toggle('hidden', !existingActive);
        mealManualPanel?.classList.toggle('hidden', !manualActive);

        mealExistingTabTrigger?.setAttribute('aria-selected', existingActive ? 'true' : 'false');
        mealManualTabTrigger?.setAttribute('aria-selected', manualActive ? 'true' : 'false');

        mealExistingTabTrigger?.classList.toggle('bg-brand-600', existingActive);
        mealExistingTabTrigger?.classList.toggle('text-white', existingActive);
        mealExistingTabTrigger?.classList.toggle('bg-slate-100', !existingActive);
        mealExistingTabTrigger?.classList.toggle('text-slate-700', !existingActive);

        mealManualTabTrigger?.classList.toggle('bg-brand-600', manualActive);
        mealManualTabTrigger?.classList.toggle('text-white', manualActive);
        mealManualTabTrigger?.classList.toggle('bg-slate-100', !manualActive);
        mealManualTabTrigger?.classList.toggle('text-slate-700', !manualActive);
      }

      function setMealMode(mode) {
        mealMode = mode;
        setMealModeStyles(mode);
      }

      function syncTabInUrl(activeTab) {
        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set('tab', activeTab);
        window.history.replaceState({}, '', `${nextUrl.pathname}?${nextUrl.searchParams.toString()}`);
      }

      function productLabel(product) {
        const brandPart = product.brand ? ` - ${product.brand}` : '';
        const servingPart = product.servingSizeLabel ? ` (${product.servingSizeLabel})` : '';
        return `${product.name}${brandPart}${servingPart}`;
      }

      function renderProductOptions(query) {
        if (!mealProductSelect) {
          return;
        }

        const filtered = products.filter((product) => fuzzyMatch(productLabel(product), query));
        mealProductSelect.innerHTML = '';

        if (filtered.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No matching products';
          mealProductSelect.append(option);
          mealProductSelect.value = '';
          return;
        }

        filtered.forEach((product) => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = productLabel(product);
          mealProductSelect.append(option);
        });
      }

      async function loadUnitAliases() {
        const response = await fetch('/api/settings');
        if (!response.ok) {
          return;
        }

        const data = await response.json();
        unitAliases = normalizeAliases(data?.settings?.customUnitAliases ?? []);
        const unitOptions = buildUnitOptions(unitAliases);
        applyUnitOptions(mealQuantityUnitSelect, unitOptions);
        applyUnitOptions(manualQuantityUnitSelect, unitOptions);
        applyUnitOptions(productReferenceUnitSelect, unitOptions);
      }

      async function loadProducts() {
        if (productsLoaded || !mealExistingForm) {
          return;
        }

        const response = await fetch('/api/products');
        if (!response.ok) {
          if (mealExistingError) {
            mealExistingError.textContent = 'Unable to load products. Please try again.';
          }
          return;
        }

        const data = await response.json();
        products = Array.isArray(data.products) ? data.products : [];
        productsLoaded = true;

        if (products.length === 0) {
          if (mealExistingError) {
            mealExistingError.textContent = 'No products found. Add one in the Product tab first.';
          }
          if (mealProductSelect) {
            mealProductSelect.innerHTML = '';
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No products available';
            mealProductSelect.append(option);
          }
          return;
        }

        if (mealExistingError) {
          mealExistingError.textContent = '';
        }
        renderProductOptions('');
      }

      async function setTab(activeTab, shouldSyncUrl) {
        setTabStyles(activeTab);
        if (shouldSyncUrl) {
          syncTabInUrl(activeTab);
        }
        if (activeTab === 'meal') {
          await loadProducts();
        }
      }

      productSearch?.addEventListener('input', () => {
        renderProductOptions(productSearch.value);
      });

      mealExistingTabTrigger?.addEventListener('click', () => {
        setMealMode('existing');
      });

      mealManualTabTrigger?.addEventListener('click', () => {
        setMealMode('manual');
      });

      mealTabTrigger?.addEventListener('click', () => {
        setTab('meal', true);
      });

      productTabTrigger?.addEventListener('click', () => {
        setTab('product', true);
      });

      mealExistingForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (mealExistingError) {
          mealExistingError.textContent = '';
        }

        const formData = new FormData(mealExistingForm);
        const productId = String(formData.get('productId') || '');
        const selectedProduct = products.find((item) => item.id === productId);

        if (!selectedProduct) {
          if (mealExistingError) {
            mealExistingError.textContent = 'Select a product before saving the meal.';
          }
          return;
        }

        const quantityValue = Number(formData.get('quantityValue'));
        const quantityUnit = String(formData.get('quantityUnit'));
        const basis = parseServingSizeLabel(selectedProduct.servingSizeLabel);

        if (!basis) {
          if (mealExistingError) {
            mealExistingError.textContent = 'This product has no nutrition basis. Update it in the Product tab first.';
          }
          return;
        }

        const normalizedQuantity = resolveToCanonical(quantityValue, quantityUnit, unitAliases);
        if (!normalizedQuantity.ok) {
          if (mealExistingError) {
            mealExistingError.textContent = normalizedQuantity.error;
          }
          return;
        }

        if (normalizedQuantity.unit !== basis.unit) {
          if (mealExistingError) {
            mealExistingError.textContent = `Unit mismatch: this product is defined per ${basis.value} ${basis.unit}, so log using ${basis.unit}.`;
          }
          return;
        }

        const factor = normalizedQuantity.value / basis.value;
        const calories = Number(selectedProduct.calories ?? 0) * factor;
        const protein = Number(selectedProduct.protein ?? 0) * factor;
        const carbs = Number(selectedProduct.carbs ?? 0) * factor;
        const fat = Number(selectedProduct.fat ?? 0) * factor;
        const body = {
          mealType: String(formData.get('mealType')),
          productId,
          quantityValue: normalizedQuantity.value,
          quantityUnit: normalizedQuantity.unit,
          calories,
          protein,
          carbs,
          fat,
          snapshot: {
            itemName: selectedProduct.name,
            brand: selectedProduct.brand ?? null,
            servingBasis: `${basis.value} ${basis.unit}`,
            source: 'product-library'
          }
        };

        const response = await fetch('/api/logs/meals', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          window.location.href = '/';
          return;
        }

        if (mealExistingError) {
          mealExistingError.textContent = 'Could not save meal. Please review inputs and try again.';
        }
      });

      mealManualForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (mealManualError) {
          mealManualError.textContent = '';
        }

        const formData = new FormData(mealManualForm);
        const quantityValue = Number(formData.get('quantityValue'));
        const quantityUnit = String(formData.get('quantityUnit'));
        const normalizedQuantity = resolveToCanonical(quantityValue, quantityUnit, unitAliases);
        if (!normalizedQuantity.ok) {
          if (mealManualError) {
            mealManualError.textContent = normalizedQuantity.error;
          }
          return;
        }

        const body = {
          mealType: String(formData.get('mealType')),
          quantityValue: normalizedQuantity.value,
          quantityUnit: normalizedQuantity.unit,
          calories: Number(formData.get('calories')),
          protein: Number(formData.get('protein')),
          carbs: Number(formData.get('carbs')),
          fat: Number(formData.get('fat')),
          snapshot: {
            itemName: String(formData.get('itemName') || '').trim() || null,
            source: 'manual-add'
          }
        };

        const response = await fetch('/api/logs/meals', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          window.location.href = '/';
          return;
        }

        if (mealManualError) {
          mealManualError.textContent = 'Could not save meal. Please review inputs and try again.';
        }
      });

      productForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(productForm);
        const referenceValue = Number(formData.get('referenceValue'));
        const referenceUnit = String(formData.get('referenceUnit'));
        const normalizedReference = resolveToCanonical(referenceValue, referenceUnit, unitAliases);
        if (!normalizedReference.ok) {
          window.alert(normalizedReference.error);
          return;
        }

        const body = {
          name: String(formData.get('name')),
          brand: String(formData.get('brand') || ''),
          calories: parseOptionalNumber(formData.get('calories')),
          protein: parseOptionalNumber(formData.get('protein')),
          carbs: parseOptionalNumber(formData.get('carbs')),
          fat: parseOptionalNumber(formData.get('fat')),
          servingSizeLabel: `${formatAmount(normalizedReference.value)} ${normalizedReference.unit}`,
          source: formData.get('isAiEstimated') ? 'AI_ESTIMATE' : 'MANUAL',
          isAiEstimated: Boolean(formData.get('isAiEstimated'))
        };

        const response = await fetch('/api/products', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          window.location.href = '/profile';
        }
      });

      applyUnitOptions(mealQuantityUnitSelect, CANONICAL_UNITS);
      applyUnitOptions(manualQuantityUnitSelect, CANONICAL_UNITS);
      applyUnitOptions(productReferenceUnitSelect, CANONICAL_UNITS);
      loadUnitAliases();

      const initialTab = root.dataset.initialTab === 'product' ? 'product' : 'meal';
      setTab(initialTab, false);
      setMealMode('existing');
    }

    document.addEventListener('astro:page-load', initAddPage);
    initAddPage();
  </script>
</AppLayout>
