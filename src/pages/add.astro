---
import AppLayout from '../layouts/AppLayout.astro';
import AuthRequired from '../components/AuthRequired.astro';

const locale: 'en' | 'de' = 'en';
const selectedTab = Astro.url.searchParams.get('tab') === 'product' ? 'product' : 'meal';
const user = (Astro.locals as any)?.user ?? null;
---

<AppLayout title="Add" currentTab="add" locale={locale}>
  {
    !user ? (
      <AuthRequired />
    ) : (
      <section class="mb-4 rounded-2xl app-card p-4 rise">
    <h1 class="mb-3 text-xl font-semibold">Quick Add</h1>
    <div class="mb-4 grid grid-cols-2 gap-2">
      <a
        href="/add?tab=meal"
        class:list={[
          'rounded-xl px-4 py-2 text-center text-sm font-medium',
          selectedTab === 'meal' ? 'bg-brand-600 text-white' : 'bg-slate-100 text-slate-700'
        ]}
      >
        Meal
      </a>
      <a
        href="/add?tab=product"
        class:list={[
          'rounded-xl px-4 py-2 text-center text-sm font-medium',
          selectedTab === 'product' ? 'bg-brand-600 text-white' : 'bg-slate-100 text-slate-700'
        ]}
      >
        Product
      </a>
    </div>

    {
      selectedTab === 'meal' ? (
        <form id="meal-form" class="space-y-3">
          <label class="block text-sm">
            <span class="mb-1 block text-slate-700">Meal Type</span>
            <select name="mealType" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
              <option value="BREAKFAST">Breakfast</option>
              <option value="LUNCH">Lunch</option>
              <option value="DINNER">Dinner</option>
              <option value="SNACKS">Snacks</option>
            </select>
          </label>

          <label class="block text-sm">
            <span class="mb-1 block text-slate-700">Item Name</span>
            <input
              required
              type="text"
              name="itemName"
              class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2"
              placeholder="e.g. Greek Yogurt"
            />
          </label>

          <div class="grid grid-cols-2 gap-3">
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Quantity</span>
              <input required min="1" type="number" name="quantityValue" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>

            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Unit</span>
              <select name="quantityUnit" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2">
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="serving">serving</option>
                <option value="piece">piece</option>
              </select>
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">kcal</span>
              <input required min="0" type="number" step="0.1" name="calories" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Protein</span>
              <input required min="0" type="number" step="0.1" name="protein" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Carbs</span>
              <input required min="0" type="number" step="0.1" name="carbs" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Fat</span>
              <input required min="0" type="number" step="0.1" name="fat" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
          </div>

          <button class="w-full rounded-xl bg-brand-600 px-4 py-2 font-semibold text-white hover:bg-brand-700" type="submit">
            Save meal entry
          </button>
        </form>
      ) : (
        <form id="product-form" class="space-y-3">
          <label class="block text-sm">
            <span class="mb-1 block text-slate-700">Name</span>
            <input required name="name" type="text" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
          </label>
          <label class="block text-sm">
            <span class="mb-1 block text-slate-700">Brand</span>
            <input name="brand" type="text" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
          </label>

          <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">kcal</span>
              <input min="0" type="number" step="0.1" name="calories" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Protein</span>
              <input min="0" type="number" step="0.1" name="protein" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Carbs</span>
              <input min="0" type="number" step="0.1" name="carbs" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
            <label class="block text-sm">
              <span class="mb-1 block text-slate-700">Fat</span>
              <input min="0" type="number" step="0.1" name="fat" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2" />
            </label>
          </div>

          <label class="inline-flex items-center gap-2 text-sm text-slate-700">
            <input type="checkbox" name="isAiEstimated" class="rounded" />
            AI-estimated nutrition (cannot be globally published)
          </label>

          <button class="w-full rounded-xl bg-brand-600 px-4 py-2 font-semibold text-white hover:bg-brand-700" type="submit">
            Save local product
          </button>
        </form>
      )
    }
      </section>
    )
  }

  <script>
    // @ts-nocheck
    const mealForm = document.querySelector('#meal-form');
    if (mealForm) {
      mealForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(mealForm as HTMLFormElement);
        const body = {
          mealType: String(formData.get('mealType')),
          quantityValue: Number(formData.get('quantityValue')),
          quantityUnit: String(formData.get('quantityUnit')),
          calories: Number(formData.get('calories')),
          protein: Number(formData.get('protein')),
          carbs: Number(formData.get('carbs')),
          fat: Number(formData.get('fat')),
          snapshot: {
            itemName: String(formData.get('itemName')),
            source: 'manual-add'
          }
        };

        const response = await fetch('/api/logs/meals', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          window.location.href = '/';
        }
      });
    }

    const productForm = document.querySelector('#product-form');
    if (productForm) {
      productForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(productForm as HTMLFormElement);
        const body = {
          name: String(formData.get('name')),
          brand: String(formData.get('brand') || ''),
          calories: Number(formData.get('calories') || 0),
          protein: Number(formData.get('protein') || 0),
          carbs: Number(formData.get('carbs') || 0),
          fat: Number(formData.get('fat') || 0),
          source: formData.get('isAiEstimated') ? 'AI_ESTIMATE' : 'MANUAL',
          isAiEstimated: Boolean(formData.get('isAiEstimated'))
        };

        const response = await fetch('/api/products', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          window.location.href = '/profile';
        }
      });
    }
  </script>
</AppLayout>
